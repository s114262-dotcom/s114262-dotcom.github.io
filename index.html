<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>日程表</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { margin:0; font-family:Arial, sans-serif; background:#f4f4f4; }
header { background:#4a6fa5; color:white; padding:15px; text-align:center; }
.container { max-width:1100px; margin:auto; padding:20px; }

.calendar { display:grid; grid-template-columns:repeat(3,1fr); gap:15px; }
.month-box { background:white; padding:15px; border-radius:10px; text-align:center; cursor:pointer; box-shadow:0 2px 5px rgba(0,0,0,.1); }

.month-view { margin-top:20px; background:white; padding:20px; border-radius:10px; }
.days { display:grid; grid-template-columns:repeat(7,1fr); gap:6px; margin-top:10px; }
.week { text-align:center; font-weight:bold; }
.day { border:1px solid #ddd; min-height:60px; padding:6px; border-radius:6px; cursor:pointer; position:relative; }
.badge { position:absolute; top:4px; right:4px; background:#4a6fa5; color:white; font-size:12px; padding:2px 6px; border-radius:10px; }

.panel { background:white; padding:15px; border-radius:10px; margin-top:15px; }
.task { padding:6px; margin:6px 0; border-radius:6px; }
.scheduled { background:#e8f5e9; }
.unscheduled { background:#fdecea; }

input, button { width:100%; padding:8px; margin:6px 0; border-radius:6px; }
button { background:#4a6fa5; color:white; border:none; cursor:pointer; }
.small { width:auto; padding:4px 8px; font-size:12px; margin-left:6px; }

.layout { display:grid; grid-template-columns:2fr 1fr; gap:20px; }
</style>
</head>

<body>
<header><h1>日程表</h1></header>

<div class="container">

<div id="calendar" class="calendar"></div>

<div class="layout">
  <div id="monthView" class="month-view"></div>

  <div class="panel">
    <h3 id="dayTitle">請選擇日期</h3>
    <div id="dayTasks"></div>

    <h4>手動排程（未排任務）</h4>
    <div id="manualTasks"></div>
  </div>
</div>

<div class="panel">
  <h3>新增任務</h3>
  <input id="taskName" placeholder="任務名稱">
  <input id="taskHours" type="number" placeholder="小時（不可切割）">
  <input id="taskDeadline" type="date">
  <button onclick="addTask()">加入任務</button>

  <h4>任務清單</h4>
  <div id="taskList"></div>

  <button onclick="autoSchedule()">自動排程</button>
</div>

</div>

<script>
const STORAGE = "AUTO_SCHEDULER";
let tasks = JSON.parse(localStorage.getItem(STORAGE) || "[]");
let schedule = {};
let currentDate = null;

function save(){ localStorage.setItem(STORAGE, JSON.stringify(tasks)); }

function rebuild(){
  schedule = {};
  tasks.forEach(t=>{
    if(t.date){
      schedule[t.date]=schedule[t.date]||[];
      schedule[t.date].push(t);
    }
  });
  openMonth(new Date().getFullYear(), new Date().getMonth()+1);
}

const calendar = document.getElementById("calendar");
for(let m=1;m<=12;m++){
  const b=document.createElement("div");
  b.className="month-box";
  b.textContent=m+" 月";
  b.onclick=()=>openMonth(new Date().getFullYear(),m);
  calendar.appendChild(b);
}

function openMonth(y,m){
  const mv=document.getElementById("monthView");
  mv.innerHTML=`<h2>${y}年 ${m}月</h2>`;
  const days=document.createElement("div");
  days.className="days";

  ["日","一","二","三","四","五","六"].forEach(w=>{
    const d=document.createElement("div");
    d.className="week"; d.textContent=w;
    days.appendChild(d);
  });

  const first=new Date(y,m-1,1).getDay();
  const total=new Date(y,m,0).getDate();
  for(let i=0;i<first;i++) days.appendChild(document.createElement("div"));

  for(let d=1;d<=total;d++){
    const cell=document.createElement("div");
    cell.className="day";
    cell.textContent=d;
    const key=`${y}-${m}-${d}`;
    if(schedule[key]){
      const badge=document.createElement("div");
      badge.className="badge";
      badge.textContent=schedule[key].length;
      cell.appendChild(badge);
    }
    cell.onclick=()=>showDay(key);
    days.appendChild(cell);
  }
  mv.appendChild(days);
}

function showDay(key){
  currentDate=key;
  dayTitle.textContent="日期："+key;
  dayTasks.innerHTML="";
  manualTasks.innerHTML="";

  (schedule[key]||[]).forEach(t=>{
    const div=document.createElement("div");
    div.className="task scheduled";
    div.textContent=t.name;
    dayTasks.appendChild(div);
  });

  tasks.filter(t=>!t.date).forEach(t=>{
    const div=document.createElement("div");
    div.className="task unscheduled";
    div.textContent=t.name;
    const btn=document.createElement("button");
    btn.textContent="排到今天";
    btn.className="small";
    btn.onclick=()=>{
      t.date=key;
      save(); rebuild(); showDay(key);
    };
    div.appendChild(btn);
    manualTasks.appendChild(div);
  });
}

function addTask(){
  if(!taskName.value||!taskDeadline.value) return alert("請填完整");
  tasks.push({name:taskName.value,hours:taskHours.value,deadline:taskDeadline.value,date:null});
  save(); renderTasks();
}

function renderTasks(){
  taskList.innerHTML="";
  tasks.forEach((t,i)=>{
    const div=document.createElement("div");
    div.className="task";
    div.textContent=t.name;
    const del=document.createElement("button");
    del.textContent="刪除";
    del.className="small";
    del.onclick=()=>{
      tasks.splice(i,1);
      save(); rebuild(); renderTasks();
    };
    div.appendChild(del);
    taskList.appendChild(div);
  });
}

function autoSchedule(){
  tasks.forEach(t=>t.date=null);
  let day=new Date();
  tasks.forEach(t=>{
    const key=`${day.getFullYear()}-${day.getMonth()+1}-${day.getDate()}`;
    t.date=key;
    day.setDate(day.getDate()+1);
  });
  save(); rebuild();
  alert("自動排程完成");
}

renderTasks();
rebuild();
</script>
</body>
</html>

renderTasks();
openMonth(YEAR, now.getMonth()+1);
</script>

</body></html>
